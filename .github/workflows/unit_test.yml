name: Comprehensive CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Formatting check
  rustfmt:
    name: Formatting Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  # Linting with clippy
  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-clippy-${{ hashFiles('**/Cargo.lock') }}
      - name: Install dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git python3 libpython3-dev protobuf-compiler
      - name: Run clippy
        run: cargo clippy --all-targets --all-features --workspace -- -D warnings

  # Cross-platform tests
  test:
    name: Test Suite
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            setup: |
              sudo apt-get update
              sudo apt-get install -y build-essential cmake git python3 libpython3-dev protobuf-compiler
          - os: macos-latest
            setup: |
              brew install protobuf
          - os: windows-latest
            setup: |
              choco install protoc
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-test-${{ hashFiles('**/Cargo.lock') }}
      - name: Install dependencies
        shell: bash
        run: ${{ matrix.setup }}
      - name: Test fff-core with all features
        run: cargo test -p fff-core --all-features
      - name: Test fff-format with all features
        run: cargo test -p fff-format --all-features
      - name: Test fff-encoding with all features
        run: cargo test -p fff-encoding --all-features
      - name: Test fff-ude with all features
        run: cargo test -p fff-ude --all-features
      - name: Test fff-poc with all features
        run: cargo test -p fff-poc --all-features
      - name: Test fff-poc with default features
        run: cargo test -p fff-poc
      - name: Benchmark smoke tests
        run: cargo test -p fff-bench --all-features --lib

  # Coverage reporting (Linux only)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Cache build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-coverage-${{ hashFiles('**/Cargo.lock') }}
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake git python3 libpython3-dev protobuf-compiler
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin || true
      - name: Generate coverage
        run: cargo tarpaulin --workspace --all-features --timeout 300 --out Xml --output-dir coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: coverage/cobertura.xml
          fail_ci_if_error: false